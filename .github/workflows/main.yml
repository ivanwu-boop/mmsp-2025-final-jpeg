name: MMSP JPEG Codec CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. 安裝工具 (加入 unzip)
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc make unzip

      # 2. 編譯程式
      - name: Compile Encoder and Decoder
        run: |
          if [ -f Makefile ]; then
            make clean 2>/dev/null || true
            make
          else
            echo "Compiling manually..."
            gcc -o encoder encoder.c -lm
            gcc -o decoder decoder.c -lm
          fi

      # 3. 準備圖片 (關鍵步驟：解壓縮 + 檢查)
      - name: Prepare Test Image
        run: |
          # 如果有 ZIP 就解壓縮
          if [ -f "Kimberly.zip" ]; then
            echo "Found Kimberly.zip, unzipping..."
            unzip -o Kimberly.zip
          fi

          # 檢查圖片是否存在與大小
          if [ -f "Kimberly.bmp" ]; then
            echo "✅ Kimberly.bmp found!"
            ls -lh Kimberly.bmp
          else
            echo "❌ Error: Kimberly.bmp NOT found."
            echo "Please upload Kimberly.zip or Kimberly.bmp to the repository."
            exit 1
          fi

      # 4. 執行測試 (加入 ulimit 防止大圖崩潰)
      - name: Run JPEG Codec Pipeline
        run: |
          # 【重要】解除 Stack 記憶體限制，防止 36MB 大圖造成 Segmentation fault
          ulimit -s unlimited
          
          chmod +x encoder decoder
          
          echo "=== Method 0 ==="
          ./encoder 0 Kimberly.bmp R.txt G.txt B.txt dim.txt
          ./decoder 0 Res0.bmp R.txt G.txt B.txt dim.txt
          
          echo "=== Method 1 ==="
          ./encoder 1 Kimberly.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt qF_Y.raw qF_Cb.raw qF_Cr.raw eF_Y.raw eF_Cb.raw eF_Cr.raw
          
          echo "=== Method 2 ==="
          ./decoder 2 Kimberly.bmp Rec.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt qF_Y.raw qF_Cb.raw qF_Cr.raw
          
          echo "=== Method 3 ==="
          ./encoder 3 Kimberly.bmp DC_Y.txt DC_Cb.txt DC_Cr.txt AC_Y.txt AC_Cb.txt AC_Cr.txt dim.txt

      # 5. 上傳結果
      - name: Upload Results (Artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: mmsp-jpeg-results
          path: |
            *.bmp
            *.txt
            *.raw
            !Kimberly.bmp
          retention-days: 30
