name: MMSP JPEG Codec CI/CD

# 觸發條件：當推送到 main 分支時執行
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      # 1. 下載程式碼
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 安裝必要工具 (包含 unzip 用來解壓縮圖片)
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc make unzip

      # 3. 編譯程式 (自動偵測是否有 Makefile)
      - name: Compile Encoder and Decoder
        run: |
          if [ -f Makefile ]; then
            echo "Makefile detected, running make..."
            make clean 2>/dev/null || true
            make
          else
            echo "No Makefile detected, compiling manually..."
            gcc -o encoder encoder.c -lm
            gcc -o decoder decoder.c -lm
          fi
          # 顯示編譯結果確認
          ls -l encoder decoder

      # 4. 準備測試圖片 (處理 ZIP 檔)
      - name: Prepare Test Image
        run: |
          # 如果發現 Kimberly.zip 就解壓縮
          if [ -f "Kimberly.zip" ]; then
            echo "Found Kimberly.zip, unzipping..."
            unzip Kimberly.zip
          fi

          # 確認解壓縮後有沒有 Kimberly.bmp
          if [ -f "Kimberly.bmp" ]; then
            echo "✅ Kimberly.bmp is ready!"
          else
            echo "❌ Error: Kimberly.bmp not found! Please upload Kimberly.zip or Kimberly.bmp"
            exit 1
          fi

      # 5. 執行所有測試 (Method 0 - 3)
      - name: Run JPEG Codec Pipeline
        run: |
          # 給予執行權限
          chmod +x encoder decoder
          
          echo "=== Method 0: Color Space Transformation ==="
          ./encoder 0 Kimberly.bmp R.txt G.txt B.txt dim.txt
          ./decoder 0 Res0.bmp R.txt G.txt B.txt dim.txt
          
          echo "=== Method 1: DCT & Quantization (Encoder) ==="
          ./encoder 1 Kimberly.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt qF_Y.raw qF_Cb.raw qF_Cr.raw eF_Y.raw eF_Cb.raw eF_Cr.raw
          
          echo "=== Method 2: IDCT & Dequantization (Decoder) ==="
          ./decoder 2 Kimberly.bmp Rec.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt qF_Y.raw qF_Cb.raw qF_Cr.raw
          
          echo "=== Method 3: DPCM & Huffman/RLE ==="
          ./encoder 3 Kimberly.bmp DC_Y.txt DC_Cb.txt DC_Cr.txt AC_Y.txt AC_Cb.txt AC_Cr.txt dim.txt

      # 6. 打包結果上傳 (Artifacts)
      - name: Upload Results (Artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: mmsp-jpeg-results
          path: |
            *.bmp
            *.txt
            *.raw
            !Kimberly.bmp
          retention-days: 30
